# _     _            _        _          _____
#| |__ | | __ _  ___| | _____| | ___   _|___ /
#| '_ \| |/ _` |/ __| |/ / __| |/ / | | | |_ \
#| |_) | | (_| | (__|   <\__ \   <| |_| |___) |
#|_.__/|_|\__,_|\___|_|\_\___/_|\_\\__, |____/
#                                  |___/

#Maintainer: blacksky3 <blacksky3@tuta.io> <https://github.com/blacksky3>
#Credits: Dan Johansen <strit@manjaro.org>
#Credits: Kevin Mihelich <kevin@archlinuxarm.org>

################################# Arch ################################

KARCH=arm64

#######################################################################

pkgbase=linux-manjaro-aarch64
pkgname=("$pkgbase" "$pkgbase-headers")
for _p in "${pkgname[@]}"; do
  eval "package_$_p() {
    $(declare -f "_package${_p#$pkgbase}")
    _package${_p#$pkgbase}
  }"
done
pkgver=5.16.13
pkgrel=1
arch=(aarch64)
url='https://www.kernel.org/'
license=(GPL-2.0)
makedepends=(make xmlto docbook-xsl kmod inetutils bc git uboot-tools dtc
             aarch64-linux-gnu-binutils aarch64-linux-gnu-gcc aarch64-linux-gnu-gdb
             aarch64-linux-gnu-glibc aarch64-linux-gnu-linux-api-headers)
options=(!strip)

archlinuxarmsource=https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/fbe494e99334dd6a8d494dce1b18fa17e44888fc/core/linux-aarch64
manjarosource=https://gitlab.manjaro.org/manjaro-arm/packages/core/linux/-/raw/88dea1bebf0a3dd246aeae21d0d6cb95908858ea

source=(https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-$pkgver.tar.xz
        ${manjarosource}/config
        linux.preset
        60-linux.hook
        90-linux.hook
        # linux-aarch64 patches <https://github.com/archlinuxarm/PKGBUILDs/tree/master/core/linux-aarch64>
        ${archlinuxarmsource}/0001-net-smsc95xx-Allow-mac-address-to-be-set-as-a-parame.patch
        ${archlinuxarmsource}/0002-arm64-dts-rockchip-disable-pwm0-on-rk3399-firefly.patch
        # ALARM patches
        # Manjaro ARM Patches
        ${manjarosource}/1001-arm64-dts-allwinner-add-hdmi-sound-to-pine-devices.patch            # Pine64
        ${manjarosource}/1002-arm64-dts-allwinner-add-ohci-ehci-to-h5-nanopi.patch                # Nanopi Neo Plus 2
        ${manjarosource}/1003-drm-bridge-analogix_dp-Add-enable_psr-param.patch                   # Pinebook Pro
        ${manjarosource}/1004-gpu-drm-add-new-display-resolution-2560x1440.patch                  # Odroid
        ${manjarosource}/1005-nuumio-panfrost-Silence-Panfrost-gem-shrinker-loggin.patch          # Panfrost
        ${manjarosource}/1006-arm64-dts-rockchip-Add-Firefly-Station-p1-support.patch             # Firelfy Station P1
        ${manjarosource}/1007-ayufan-drm-rockchip-add-support-for-modeline-32MHz-e.patch          # DP Alt mode
        ${manjarosource}/1008-rk3399-rp64-pcie-Reimplement-rockchip-PCIe-bus-scan-delay.patch     # RockPro64
        ${manjarosource}/1009-drm-meson-add-YUV422-output-support.patch                           # G12B
        ${manjarosource}/1010-arm64-dts-meson-add-initial-Beelink-GT1-Ultimate-dev.patch          # Beelink
        ${manjarosource}/1011-add-ugoos-device.patch                                              # Ugoos
        ${manjarosource}/1012-drm-panfrost-scheduler-improvements.patch                           # Panfrost
        ${manjarosource}/1013-arm64-dts-rockchip-Add-PCIe-bus-scan-delay-to-RockPr.patch          # RockPro64
        ${manjarosource}/1014-drm-rockchip-support-gamma-control-on-RK3399.patch                  # RK3399
        ${manjarosource}/1015-media-rockchip-rga-do-proper-error-checking-in-probe.patch          # Rockchip
        #${manjarosource}/1016-arm-dts-rockchip-firefly-station-m2.patch                          # Firefly Station M2
        #${manjarosource}/1017-add-dts-rk3568-station-p2.patch                                    # Firefly Station P2
        #${manjarosource}/1018-add-dts-rk3568-radxa-rock3a.patch                                  # Radxa Rock3A
        ${manjarosource}/1019-arm64-dts-rockchip-switch-to-hs200-on-rockpi4.patch                 # Rock Pi 4
        ${manjarosource}/1020-arm64-dts-meson-remove-CPU-opps-below-1GHz-for-G12B-boards.patch    # AMLogic [1/2]
        ${manjarosource}/1021-arm64-dts-meson-remove-CPU-opps-below-1GHz-for-SM1-boards.patch     # AMLogic [2/2]
        ${manjarosource}/1022-arm64-dts-rockchip-Add-PCIe-bus-scan-delay-to-Rock-P.patch          # Rock Pi 4
        # Assorted Pinebook, PinePhone and PineTab patches
        ${manjarosource}/2001-Bluetooth-Add-new-quirk-for-broken-local-ext-features.patch         # Bluetooth
        ${manjarosource}/2002-Bluetooth-btrtl-add-support-for-the-RTL8723CS.patch                 # Bluetooth
        ${manjarosource}/2003-arm64-allwinner-a64-enable-Bluetooth-On-Pinebook.patch              # Bluetooth
        ${manjarosource}/2004-arm64-dts-allwinner-enable-bluetooth-pinetab-pinepho.patch          # Bluetooth
        ${manjarosource}/2005-staging-add-rtl8723cs-driver.patch                                  # Wifi
        ${manjarosource}/2006-arm64-dts-allwinner-pinetab-add-accelerometer.patch                 # Accelerometer
        ${manjarosource}/2007-arm64-dts-allwinner-pinetab-enable-jack-detection.patch             # Audio
        ${manjarosource}/2008-Bluetooth-Read-codec-capabilities-only-if-supported.patch           # Bluetooth
        ${manjarosource}/2009-btsdio-Do-not-bind-to-non-removable-BCM4345-and-BCM43455.patch      # Bluetooth
        # Pinebook Pro Type-C patches from megous; original patch numbers found
        # on https://xff.cz/kernels/5.16/patches/ are retained, with just the first
        # digit changed from 3 to 0, to make tracking easier
        ${manjarosource}/3172-arm64-dts-rk3399-pinebook-pro-Fix-USB-PD-charging.patch
        ${manjarosource}/3174-arm64-dts-rk3399-pinebook-pro-Improve-Type-C-support.patch
        ${manjarosource}/3176-arm64-dts-rk3399-pinebook-pro-Remove-redundant-pinct.patch
        ${manjarosource}/3376-drm-rockchip-cdn-dp-Disable-CDN-DP-on-disconnect.patch
        ${manjarosource}/3392-usb-typec-fusb302-Set-the-current-before-enabling-pu.patch
        ${manjarosource}/3396-usb-typec-fusb302-Update-VBUS-state-even-if-VBUS-int.patch
        ${manjarosource}/3398-usb-typec-fusb302-Add-OF-extcon-support.patch
        ${manjarosource}/3399-usb-typec-fusb302-Fix-register-definitions.patch
        ${manjarosource}/3400-usb-typec-fusb302-Clear-interrupts-before-we-start-t.patch
        ${manjarosource}/3401-usb-typec-typec-extcon-Add-typec-extcon-bridge-drive.patch
        ${manjarosource}/3402-phy-rockchip-typec-Make-sure-the-plug-orientation-is.patch
        ${manjarosource}/3457-phy-rockchip-inno-usb2-More-robust-charger-detection.patch
        ${manjarosource}/3458-usb-typec-extcon-Don-t-touch-charger-proprties.patch
        ${manjarosource}/3459-arm64-dts-rk3399-pinebook-pro-Don-t-allow-usb2-phy-d.patch)

prepare(){

  cd "${srcdir}"/linux-$pkgver

  # add upstream patch
  #git apply --whitespace=nowarn ../patch-${pkgver}

  # Apply any patch
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    msg2 "Applying patch $src..."
    patch -Np1 < "../$src"
  done

  # Copy the config file first
  # Copy "${srcdir}"/config to "${srcdir}"/linux-${pkgver}/.config
  msg2 "Copy "${srcdir}"/config to "${srcdir}"/linux-$pkgver/.config"
  cp "${srcdir}"/config .config

  # add pkgrel to extraversion
  #sed -ri "s|^(EXTRAVERSION =)(.*)|\1 \2-${pkgrel}|" Makefile

  scripts/config --disable CONFIG_LOCALVERSION

  msg2 "Setting localversion..."
  scripts/setlocalversion --save-scmversion
  echo "-${pkgbase}" > localversion

  make ARCH=${KARCH} CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) olddefconfig

  make -s kernelrelease > version
  msg2 "Prepared $pkgbase version $(<version)"
}

build(){

  cd "${srcdir}"/linux-$pkgver

  unset LDFLAGS

  make ARCH=${KARCH} CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) Image Image.gz modules

  # Generate device tree blobs with symbols to support applying device tree overlays in U-Boot
  make ARCH=${KARCH} CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) DTC_FLAGS="-@" dtbs
}

_package(){
  pkgdesc='The Linux Kernel and modules with Manjaro ARM patches - AArch64 multi-platform'
  depends=(coreutils linux-firmware kmod initramfs)
  optdepends=('crda: to set the correct wireless channels of your country')
  provides=("linux=${pkgver}" WIREGUARD-MODULE)
  replaces=(linux-armv8)
  conflicts=(linux)
  install=${pkgbase}.install

  cd "${srcdir}"/linux-$pkgver

  local kernver="$(<version)"
  local modulesdir="${pkgdir}"/usr/lib/modules/${kernver}

  msg2 "Installing boot image and dtbs..."
  install -Dm644 arch/arm64/boot/Image{,.gz} -t "${pkgdir}/boot"
  make ARCH=${KARCH} CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) INSTALL_DTBS_PATH="${pkgdir}/boot/dtbs" dtbs_install

  msg2 "Installing modules..."
  make ARCH=${KARCH} CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) INSTALL_MOD_PATH="${pkgdir}/usr" INSTALL_MOD_STRIP=1 modules_install

  # remove build and source links
  msg2 "Remove build dir and source dir..."
  rm -rf "$modulesdir"/{source,build}

  # sed expression for following substitutions
  local _subst="
    s|%PKGBASE%|${pkgbase}|g
    s|%KERNVER%|${kernver}|g
  "

  # install mkinitcpio preset file
  sed "${_subst}" ../linux.preset | install -Dm644 /dev/stdin "${pkgdir}/etc/mkinitcpio.d/${pkgbase}.preset"

  # install pacman hooks
  sed "${_subst}" ../60-linux.hook | install -Dm644 /dev/stdin "${pkgdir}/usr/share/libalpm/hooks/60-${pkgbase}.hook"
  sed "${_subst}" ../90-linux.hook | install -Dm644 /dev/stdin "${pkgdir}/usr/share/libalpm/hooks/90-${pkgbase}.hook"
}

_package-headers() {
  pkgdesc='Header files and scripts for building modules for linux kernel - AArch64 multi-platform'
  provides=("linux-headers=${pkgver}")
  conflicts=(linux-headers)
  depends=("${pkgbase}")

  cd "${srcdir}"/linux-$pkgver

  local builddir="${pkgdir}/usr/lib/modules/${kernver}/build"

  echo "Installing build files..."
  install -Dt "$builddir" -m644 .config Makefile Module.symvers System.map vmlinux localversion
  install -Dt "$builddir/kernel" -m644 kernel/Makefile
  install -Dt "$builddir/arch/${KARCH}" -m644 arch/${KARCH}/Makefile
  cp -t "$builddir" -a scripts

  # add xfs and shmem for aufs building
  mkdir -p "$builddir"/{fs/xfs,mm}

  echo "Installing headers..."
  cp -t "$builddir" -a include
  cp -t "$builddir/arch/${KARCH}" -a arch/${KARCH}/include
  install -Dt "$builddir/arch/${KARCH}/kernel" -m644 arch/${KARCH}/kernel/asm-offsets.s
  mkdir -p "$builddir/arch/arm"
  cp -t "$builddir/arch/arm" -a arch/arm/include

  install -Dt "$builddir/drivers/md" -m644 drivers/md/*.h
  install -Dt "$builddir/net/mac80211" -m644 net/mac80211/*.h

  # https://bugs.archlinux.org/task/13146
  install -Dt "$builddir/drivers/media/i2c" -m644 drivers/media/i2c/msp3400-driver.h

  # https://bugs.archlinux.org/task/20402
  install -Dt "$builddir/drivers/media/usb/dvb-usb" -m644 drivers/media/usb/dvb-usb/*.h
  install -Dt "$builddir/drivers/media/dvb-frontends" -m644 drivers/media/dvb-frontends/*.h
  install -Dt "$builddir/drivers/media/tuners" -m644 drivers/media/tuners/*.h

  # https://bugs.archlinux.org/task/71392
  install -Dt "$builddir/drivers/iio/common/hid-sensors" -m644 drivers/iio/common/hid-sensors/*.h

  echo "Installing KConfig files..."
  find . -name 'Kconfig*' -exec install -Dm644 {} "$builddir/{}" \;

  echo "Removing unneeded architectures..."
  local arch
  for arch in "$builddir"/arch/*/; do
    [[ $arch = */${KARCH}/ || $arch == */arm/ ]] && continue
    echo "Removing $(basename "$arch")"
    rm -r "$arch"
  done

  echo "Removing documentation..."
  rm -r "$builddir/Documentation"

  echo "Removing broken symlinks..."
  find -L "$builddir" -type l -printf 'Removing %P\n' -delete

  echo "Removing loose objects..."
  find "$builddir" -type f -name '*.o' -printf 'Removing %P\n' -delete

  echo "Stripping build tools..."
  local file
  while read -rd '' file; do
    case "$(file -bi "$file")" in
      application/x-sharedlib\;*)      # Libraries (.so)
        strip -v $STRIP_SHARED "$file" ;;
      application/x-archive\;*)        # Libraries (.a)
        strip -v $STRIP_STATIC "$file" ;;
      application/x-executable\;*)     # Binaries
        strip -v $STRIP_BINARIES "$file" ;;
      application/x-pie-executable\;*) # Relocatable binaries
        strip -v $STRIP_SHARED "$file" ;;
    esac
  done < <(find "$builddir" -type f -perm -u+x ! -name vmlinux -print0)

  echo "Adding symlink..."
  mkdir -p "$pkgdir/usr/src"
  ln -sr "$builddir" "$pkgdir/usr/src/$pkgbase"
}

sha256sums=(2f8a9800833aac8256be3c1c6fc87f4dc54bcca150573395eb3e5556c7267fbb
            5b63d257de8ae824514a1b68eecdfcc0fb0823926002c8b12bbc7bf0bfbe1c0e
            6837b3e2152f142f3fff595c6cbd03423f6e7b8d525aac8ae3eb3b58392bd255
            452b8d4d71e1565ca91b1bebb280693549222ef51c47ba8964e411b2d461699c
            71df1b18a3885b151a3b9d926a91936da2acc90d5e27f1ad326745779cd3759d
            c850322ad82e53807c9d4844ee11e179bbdaa8082a952c998e13969aa12dd76c
            ddd6ccf14bfd117292828a50aab6d20fae161082b0094b4f12e2628649426b66
            8d616fa1c56803861e4e014bb200e7bb7840d1ddc2fd7056d4afd372a0738bba
            f4d9a0a1861d079d2f58538686fb425a43ab23e132dccd1a7f6ceb4fd7ec3e38
            92297624436557fd1e12f50222aa296009dd59ab114abe55508f0927e831ce6c
            85c0bed95d017d6cbec240f560ed189155dbc594cdf921a7f4a45c4e13326552
            5cc20a27f0d7b1b55281d5d0a665fcfa8c4ebcb02a855fb5ccbade18912b37d7
            71d398a592215e17fd0f67fe8e4e5cae424de63dae9dcedb8e0921a0d2c38b82
            c547b3362c701d9bbce7179763c25a70453b6eb4d80f59b44a6057c6f6ed6719
            21af48bffff108e44a20ed6141abdb13202f5c114946c9d55483a8e7e6839e66
            37ba2bf45ba321dc1dd796653de193e241fbc021ba7cdb4e4741b39acff84860
            6aa38c068c18a15b17f806aa398b0e3940af2f7b47827fd8484ed8d05e4cd516
            c93a71977c568765bc551f313a87821a7a9ad1301862e581aea5126227c6172e
            763224582f19b7cd04b24b403b68d3525c7b7823438aa530d3d4dfa1670442a1
            910c9ceb91e7e1f01bcf9ba34c4c9130f50897e1d05dd694be84dbe2b0737624
            e9758d04c00deb87d80a00292f158a69ef0f7f99cf2f090b26e6d2396c6f5912
            99b912748e01ce84458708114571abcac73a5b7ec95bf0cfa92c7fa7a3990d7b
            a364abb828cb3b066b97d5eed69f40a20871befd90e19a9463aa60fd87ba030c
            d47e0e71f1cb964487ab92e6613ddfeeb53a23a5c2895ccb94799da6384e1299
            a3a93a5aebc0cf8644a93d9c28a5f17567dda1125d6178f82d3d2a0b91a70539
            ac72f5f425dc4efabd81fd5d6e828cbe5c0635b5c002f01f2fbc11370a4d0c11
            c752c6a47aa031af6ce1b576344c5611ec9765bc956f08610c77fa0bb45d8dbe
            1d64436b14f0c29138abc881576b611e240085c00d924a3eb865734c8ce4c41d
            50f677d4dca75d782577eed7b7756759f469a1e8dcaea91bc465bdc90dd466d4
            d9495dc6f26114e973d8782088d25e69b299b20c31a60bfb439509ac456ed43a
            065e16cdc31e6652cf8dac5515b4e0a8e6002134a8d03c8035466c03c739e5de
            0e6453bf258c34349e5cc76811d804392aaa1ef9230c343719879682aaff7515
            1ef1c44720798f5e7dcd57ec066e11cb0d4c4db673efcb74b2239534add9564c
            bf11a81ddb069c13720b90b8f2569a656d39c22d34bf12ece80f8b606a41f408
            5afdbcc14341953895584cf23e13e965542a9becc82d303f8af94c1aa18cebc1
            70608d8bb513df20efa29bbad26bae329c97ed742e6d1c62f21e8ddfec888243
            30b796eecaa678b4be647c31639d0b662e3e077897e832cfa9361287fc08e9b2
            30486d92105cc3267b58221fd813f3c585a460d50b68313fb2197bdf8b0b6df7
            da92f6e730331c02d1725fd2fad60675ebc013b0ddaacc00590e22ab646e110e
            7944ead2685d2aef0d979e22cc02066548f8d95a4728d90c347bf74299bcdabc
            6352bb8f45b0781cb4095e2cb4a57ef8fe1282b184fbc57251d9be7aad4f6bd7
            c1c48a179990a02c45d5f3d753ed0837ca9cb084675c6cf455b859f76b3c83c0
            115a04e229ee398687cfa121143cbc612e559b27ca14fa0fe2965763d7bd12d4
            9d10961570fe28d7adb7231a8ae7add60e8827848b8164e6586fbf9b2549caff
            879223f3bc9ca16b61d7d9664a98b54ca8fc1350b157bf3c77d73c6445493674
            622f74e913195390238436877eca299a525399c2f20e8cb3c13af39d71be01b1
            c660cc10f466243eecc4050df983ddd87e965273bccdc69a6238746534100f74
            e4f6be39d8f48dd9b9bf70c4aedeb407984602998de33de5858f3433962ceca5
            08b70dc39389a1f295c824aed3890d20f4bd7a038b2071c162a8853df24ee6ca)
